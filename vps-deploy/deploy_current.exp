#!/usr/bin/expect

set timeout 600
set password "iMpresora\$2016A"
set ip "157.230.138.178"
set user "root"

puts "========================================="
puts "Deploying CURRENT version to VPS"
puts "IP: $ip"
puts "========================================="

# 1. Create project directory
puts "\nStep 1: Creating project directory..."
spawn ssh $user@$ip "mkdir -p /root/ad-security-assessment"
expect {
    "yes/no" { send "yes\r"; exp_continue }
    "assword:" { send "$password\r" }
}
expect eof

# 2. Copy docker-compose.yml
puts "\nStep 2: Copying docker-compose.yml..."
spawn scp docker-compose.yml $user@$ip:/root/ad-security-assessment/
expect {
    "yes/no" { send "yes\r"; exp_continue }
    "assword:" { send "$password\r" }
}
expect eof

# 3. Copy init.sql
puts "\nStep 3 Copying init.sql..."
spawn scp init.sql $user@$ip:/root/ad-security-assessment/
expect {
    "yes/no" { send "yes\r"; exp_continue }
    "assword:" { send "$password\r" }
}
expect eof

# 4. Copy .env.example (will need manual configuration)
puts "\nStep 4 Copying .env.example..."
spawn scp .env.example $user@$ip:/root/ad-security-assessment/
expect {
    "yes/no" { send "yes\r"; exp_continue }
    "assword:" { send "$password\r" }
}
expect eof

# 5. Copy backend directory
puts "\nStep 5 Copying backend files..."
spawn scp -r backend $user@$ip:/root/ad-security-assessment/
expect {
    "yes/no" { send "yes\r"; exp_continue }
    "assword:" { send "$password\r" }
}
expect eof

# 6. Copy frontend directory
puts "\nStep 6 Copying frontend files..."
spawn ssh $user@$ip "mkdir -p /root/ad-security-assessment/frontend"
expect {
    "yes/no" { send "yes\r"; exp_continue }
    "assword:" { send "$password\r" }
}
expect eof

spawn scp frontend/Dockerfile $user@$ip:/root/ad-security-assessment/frontend/
expect {
    "yes/no" { send "yes\r"; exp_continue }
    "assword:" { send "$password\r" }
}
expect eof

spawn scp frontend/nginx.conf $user@$ip:/root/ad-security-assessment/frontend/
expect {
    "yes/no" { send "yes\r"; exp_continue }
    "assword:" { send "$password\r" }
}
expect eof

# 7. Copy entire project root for frontend build
puts "\nStep 7 Copying project files for frontend build..."
spawn ssh $user@$ip "mkdir -p /root/ad-security-assessment/app"
expect {
    "yes/no" { send "yes\r"; exp_continue }
    "assword:" { send "$password\r" }
}
expect eof

spawn bash -c "cd .. && tar czf - package.json package-lock.json tsconfig.json tsconfig.app.json tsconfig.node.json vite.config.ts tailwind.config.ts postcss.config.js components.json index.html src public .env.production | ssh $user@$ip 'cd /root/ad-security-assessment/app && tar xzf -'"
expect {
    "yes/no" { send "yes\r"; exp_continue }
    "assword:" { send "$password\r" }
}
expect eof

# 8. Update frontend Dockerfile to use app directory
puts "\nStep 8 Updating Dockerfile and deploying..."
spawn ssh $user@$ip "cd /root/ad-security-assessment && cat > frontend/Dockerfile << 'EOF'
FROM node:18-alpine as build

WORKDIR /app

# Copy package files
COPY app/package*.json ./
RUN npm install

# Copy all project files
COPY app/ .

# Vite automatically uses .env.production for production builds
RUN npm run build

FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY frontend/nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80
CMD [\"nginx\", \"-g\", \"daemon off;\"]
EOF
"
expect {
    "yes/no" { send "yes\r"; exp_continue }
    "assword:" { send "$password\r" }
}
expect eof

puts "\n========================================="
puts "Files copied successfully!"
puts "========================================="
puts "\nNEXT STEPS (manual):"
puts "1. SSH to VPS: ssh $user@$ip"
puts "2. cd /root/ad-security-assessment"
puts "3. cp .env.example .env"
puts "4. nano .env  (add OPENAI_API_KEY)"
puts "5. docker compose up -d --build"
puts "6. docker compose logs -f"
puts "\n========================================="
